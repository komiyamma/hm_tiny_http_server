# 既知の問題点と改善案 (Known Issues and Improvement Proposals)

このファイルには、現在の実装における潜在的な問題点や、将来的な改善案を記載します。

## 1. エラーハンドリングの強化

現状の実装では、いくつかの箇所でエラーハンドリングが十分ではありません。

- **ポート取得の失敗**: `HmGetFreePort.cs` で空きポートの取得に失敗した場合の考慮がされていません。万が一、利用可能なポートが見つからなかった場合、サーバーは起動に失敗しますが、ユーザーに具体的な原因が伝わりにくい可能性があります。
- **コマンドライン引数**: `Main`メソッドの引数チェックがインデックスの範囲のみで、内容（パスの妥当性、ハンドルの形式など）の検証が不十分です。不正な引数が与えられた場合に、予期せぬ例外が発生する可能性があります。

**改善案:**
- それぞれのエラーケースで、より具体的なエラーメッセージを標準エラー出力 (`Console.Error.WriteLine`) に出力するように修正する。

## 2. セマフォのタイムアウト値が固定

多重起動を防止するためのセマフォの待機時間が、現在2秒でハードコーディングされています。
```csharp
if (!semaphore.WaitOne(TimeSpan.FromSeconds(2))) // 2秒待機
```
通常は問題ありませんが、システムの負荷が高い状況など、何らかの理由でセマフォの解放に時間がかかった場合、タイムアウトしてしまい正常に起動できない可能性があります。

**改善案:**
- タイムアウト値を設定ファイルやコマンドライン引数で変更できるようにする、もしくは、より適切な待機処理を検討する。

## 3. PHPサーバーの標準エラー出力がリダイレクトされていない

`HmPhpProcessServer.cs` でPHPプロセスを起動する際、標準エラー出力がリダイレクトされていません。
```csharp
psi.RedirectStandardError = false;
```
これにより、PHPスクリプト内で発生したエラー（構文エラー、実行時エラーなど）が破棄されてしまい、デバッグが非常に困難になります。

**改善案:**
- `RedirectStandardError` を `true` に設定し、PHPからのエラー出力をファイルに書き出すか、このアプリケーションの標準エラーに出力するなどの方法で、エラー内容を確認できるようにする。
